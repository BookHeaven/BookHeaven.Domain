name: Publish Domain NuGet Package

on:
  push:
    branches:
      - main

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for accurate versioning

      # Setup .NET
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.x'

      # Install Nerdbank.GitVersioning
      - name: Install Nerdbank.GitVersioning
        run: dotnet tool install --global nbgv

      # Extract version from GitVersioning
      - name: Get version
        id: get-version
        run: |
          VERSION=$(nbgv get-version | grep NuGetPackageVersion | cut -d ':' -f2 | xargs)
          echo "Domain version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      # Publish Domain package
      - name: Publish NuGet package
        run: |
          dotnet pack ./BookHeaven.Domain.csproj --configuration Release --output ./packages /p:Version=$VERSION
          dotnet nuget add source \
            --username ${{ github.actor }} \
            --password ${{ secrets.GITHUB_TOKEN }} \
            --store-password-in-clear-text \
            --name github "https://nuget.pkg.github.com/BookHeaven/index.json" 
          dotnet nuget push ./packages/BookHeaven.Domain.$VERSION.nupkg \
            --source "github" \
            --api-key ${{ secrets.GITHUB_TOKEN }}
